#!/bin/bash
set -e

echo "üöÄ Starting System Services..."
echo "üß≠ SERVICE_NAME=${SERVICE_NAME}"

########################################
# Load .env
########################################
if [ -f "/app/.env" ]; then
    echo "‚úÖ Loading environment variables from .env"
    set -o allexport
    while IFS='=' read -r key value; do
        [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
        key="$(echo "$key" | xargs)"
        value="$(echo "$value" | xargs | sed -E 's/^"(.*)"$/\1/')"
        export "$key=$value"
    done < /app/.env
    set +o allexport
else
    echo "‚ö†Ô∏è .env file not found, relying on container env"
fi

########################################
# Validate required env
########################################
required_vars=(
  POSTGRES_USER
  POSTGRES_PASSWORD
  POSTGRES_DB
  POSTGRES_HOST
  POSTGRES_PORT
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "‚ùå Missing required env var: $var"
        exit 1
    fi
done

########################################
# Wait for PostgreSQL
########################################
echo "üîç Waiting for PostgreSQL at ${POSTGRES_HOST}:${POSTGRES_PORT}..."
until PGPASSWORD="$POSTGRES_PASSWORD" \
      psql -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -p "$POSTGRES_PORT" -d "$POSTGRES_DB" -c '\q' >/dev/null 2>&1; do
    sleep 2
done
echo "‚úÖ PostgreSQL is ready!"

########################################
# DB PREPARE (INIT CONTAINER)
########################################
if [ "$SERVICE_NAME" = "db_prepare" ]; then
    echo "üõ†Ô∏è Running database preparation..."

    python manage.py migrate --noinput

    echo "üë§ Ensuring superuser exists..."
    python manage.py shell <<EOF
import json
from django.contrib.auth import get_user_model
from oauth2_provider.models import Application
from oauth2_provider.generators import generate_client_secret
from custom_authentication.models import Client

User = get_user_model()
email = "$DJANGO_SUPERUSER_EMAIL"
password = "$DJANGO_SUPERUSER_PASSWORD"
outfile = "/app/logs/.superuser_secrets.json"

client, _ = Client.objects.get_or_create(
    name="AI DocuMines",
    defaults={"industry": "AI", "use_case": "Bootstrap"}
)

if not User.objects.filter(email=email).exists():
    user = User.objects.create_superuser(
        email=email,
        password=password,
        client=client
    )
    secret = generate_client_secret()
    app = Application.objects.create(
        user=user,
        client_type=Application.CLIENT_CONFIDENTIAL,
        authorization_grant_type=Application.GRANT_PASSWORD,
        name="System Admin",
        client_secret=secret
    )
    with open(outfile, "w") as f:
        json.dump({
            "email": email,
            "password": password,
            "client_id": app.client_id,
            "client_secret": secret
        }, f, indent=2)
    print("‚úÖ Superuser created")
else:
    print("‚úÖ Superuser already exists")
EOF

    touch /app/logs/migrations_complete
    echo "‚úÖ DB preparation finished ‚Äî exiting."
    exit 0
fi

########################################
# WEB (GUNICORN)
########################################
if [ "$SERVICE_NAME" = "web" ]; then
    echo "üìÇ Collecting static files..."
    python manage.py collectstatic --noinput

    echo "üåç Starting Gunicorn..."
    exec gunicorn aiDocuMines.wsgi:application \
        --bind 0.0.0.0:8020 \
        --timeout 120 \
        --log-level debug
fi

########################################
# CELERY
########################################
if [ "$SERVICE_NAME" = "celery" ]; then
    echo "üöÄ Starting Celery worker..."
    exec celery -A aiDocuMines worker --loglevel=info --concurrency=4
fi

if [ "$SERVICE_NAME" = "celery_beat" ]; then
    echo "üöÄ Starting Celery beat..."
    exec celery -A aiDocuMines beat \
        --loglevel=info \
        --scheduler django_celery_beat.schedulers:DatabaseScheduler
fi

########################################
# FILE MONITOR
########################################
if [ "$SERVICE_NAME" = "file_monitor" ]; then
    echo "üëÅÔ∏è Starting Supervisor..."
    exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
fi

########################################
# OLLAMA
########################################
if [ "$SERVICE_NAME" = "ollama" ]; then
    echo "üì¶ Pulling Ollama models..."
    ollama pull mistral || true
    ollama pull llama3 || true
    ollama pull deepseek-coder:6.7b || true
    echo "‚úÖ Ollama ready ‚Äî exiting."
    exit 0
fi

########################################
# SAFETY NET
########################################
echo "‚ùå Unknown SERVICE_NAME='$SERVICE_NAME'"
exit 1

