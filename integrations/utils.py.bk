import os
import json
import requests
import subprocess
from django.core.exceptions import ImproperlyConfigured
from oauth2_provider.models import Application
from .models import IntegrationLog


def generate_nextcloud_autologin_url(user) -> str:
    """
    Creates or syncs a Nextcloud user and uploads aiDocuMines data securely.
    Returns a one-click autologin URL.
    """

    print(f"â¡ï¸  Starting Nextcloud provisioning for user ID {user.id} ({user.email})")

    if not user.is_active:
        raise Exception("Inactive users cannot be provisioned into Nextcloud.")

    if not user.email or not user.password:
        raise Exception("Nextcloud provisioning requires a valid email and password.")

    # 1. Prepare credentials
    username = f"user_{user.id}"
    email = user.email
    password = user.temp_password or user.password
    print(f"ğŸ”‘  Using Nextcloud username={username} and email={email}")

    # 2. Get client_id from associated Application object
    try:
        app = Application.objects.filter(user=user, name__icontains="nextcloud").first()
        if not app:
            raise Exception("No Nextcloud OAuth2 application found for this user.")
        client_id = app.client_id
        print(f"ğŸ†”  Fetched client_id from Application: {client_id}")
    except Exception as e:
        raise Exception(f"Unable to retrieve client_id: {str(e)}")

    # 3. Load config
    NEXTCLOUD_ADMIN_USER = os.getenv("NEXTCLOUD_ADMIN_USER", "admin@aidocumines.com")
    NEXTCLOUD_ADMIN_PASS = os.getenv("NEXTCLOUD_ADMIN_PASS")
    NEXTCLOUD_URL = os.getenv("NEXTCLOUD_URL", "https://nextcloud.aidocumines.com")
    NC_CONTAINER_NAME = os.getenv("NEXTCLOUD_DOCKER_CONTAINER", "srv-captain--nextcloud")
    AIDOCUMINES_DATA = os.getenv("AIDOCUMINES_DATA", "/home/aidocumines/Apps/aiDocuMines/media/uploads")

    if not NEXTCLOUD_ADMIN_PASS:
        raise ImproperlyConfigured("Missing NEXTCLOUD_ADMIN_PASS in environment.")

    print(f"ğŸŒ  Loaded env: NEXTCLOUD_URL={NEXTCLOUD_URL}, DATA_ROOT={AIDOCUMINES_DATA}")

    headers = {
        "OCS-APIRequest": "true",
        "Accept": "application/json"
    }

    try:
        # 4. Check or create Nextcloud user
        check_url = f"{NEXTCLOUD_URL}/ocs/v1.php/cloud/users/{username}"
        print(f"ğŸ”  Checking if Nextcloud user exists: {check_url}")
        resp = requests.get(check_url, auth=(NEXTCLOUD_ADMIN_USER, NEXTCLOUD_ADMIN_PASS), headers=headers)

        if resp.status_code == 404:
            print("â•  User not found â€“ creating in Nextcloudâ€¦")
            create_url = f"{NEXTCLOUD_URL}/ocs/v1.php/cloud/users"
            data = {"userid": username, "password": password, "email": email}
            create_resp = requests.post(create_url, auth=(NEXTCLOUD_ADMIN_USER, NEXTCLOUD_ADMIN_PASS), data=data, headers=headers)
            print(f"ğŸ“¡  Create response: {create_resp.status_code} {create_resp.text}")
            if create_resp.status_code >= 400:
                IntegrationLog.objects.create(user=user, connector="nextcloud", status="failed", details=f"User creation failed: {create_resp.text}")
                raise Exception(f"Nextcloud user creation failed: {create_resp.text}")
            IntegrationLog.objects.create(user=user, connector="nextcloud", status="created", details=f"User {username} created in Nextcloud")

        elif resp.status_code == 200:
            print("â™»ï¸  User exists â€“ resetting passwordâ€¦")
            reset_url = f"{NEXTCLOUD_URL}/ocs/v1.php/cloud/users/{username}/password"
            reset_resp = requests.put(reset_url, auth=(NEXTCLOUD_ADMIN_USER, NEXTCLOUD_ADMIN_PASS), data={"password": password}, headers=headers)
            print(f"ğŸ”„  Password reset response: {reset_resp.status_code}")
            if reset_resp.status_code >= 400:
                raise Exception(f"Password reset failed: {reset_resp.text}")
            IntegrationLog.objects.create(user=user, connector="nextcloud", status="reset", details=f"Password reset for user {username}")
        else:
            raise Exception(f"Unexpected response from Nextcloud: {resp.status_code} - {resp.text}")

        # 5. Locate local user data folder
        user_data_path = os.path.join(AIDOCUMINES_DATA, client_id, str(user.id))
        print(f"ğŸ“  Checking local user data path: {user_data_path}")
        if not os.path.exists(user_data_path):
            raise Exception(f"No data found for user {user.id} at {user_data_path}")

        print(f"âœ…  Data folder exists. Listing contents of {user_data_path}:")
        for item in os.listdir(user_data_path):
            print(f"   - {item}")

        # 6. Detect Nextcloud host volume path
        inspect_cmd = f"docker inspect {NC_CONTAINER_NAME}"
        print(f"ğŸ”  Inspecting container {NC_CONTAINER_NAME}")
        inspect_output = subprocess.check_output(inspect_cmd, shell=True)
        container_info = json.loads(inspect_output)[0]
        mounts = container_info.get("Mounts", [])
        NC_DATA_HOST = next((m["Source"] for m in mounts if m["Destination"] == "/var/www/html"), None)

        if not NC_DATA_HOST:
            raise Exception("Could not determine Nextcloud volume host path.")
        print(f"ğŸ—‚ï¸  Host-mounted /var/www/html path: {NC_DATA_HOST}")

        # 7. Rsync data
        nextcloud_user_files = os.path.join(NC_DATA_HOST, "data", username, "files")
        print(f"ğŸ“¦  Syncing files to Nextcloud path: {nextcloud_user_files}")
        os.makedirs(nextcloud_user_files, exist_ok=True)

        sync_cmd = ["rsync", "-a", "--delete", f"{user_data_path}/", f"{nextcloud_user_files}/"]
        print(f"ğŸ›°ï¸  Running rsync command: {' '.join(sync_cmd)}")
        subprocess.run(sync_cmd, check=True)

        # 8. Trigger file indexing
        print(f"ğŸ”„  Running OCC files:scan for {username}")
        subprocess.run([
            "docker", "exec", "-u", "www-data", NC_CONTAINER_NAME,
            "php", "occ", "files:scan", username
        ], check=True)

        IntegrationLog.objects.create(user=user, connector="nextcloud", status="success", details=f"Synced folder for user {username}")
        print(f"ğŸ‰  Sync complete. Folder is now active in Nextcloud.")

        # 9. Return login link
        autologin_url = f"https://{username}:{password}@{NEXTCLOUD_URL.replace('https://', '')}"
        print(f"ğŸ”—  Autologin URL: {autologin_url}")
        return autologin_url

    except Exception as e:
        IntegrationLog.objects.create(user=user, connector="nextcloud", status="error", details=str(e))
        print(f"âŒ  ERROR: {str(e)}")
        raise

